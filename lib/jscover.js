/*!
 * jscover - lib/jscover.js
 * Copyright(c) 2012 fengmk2 <fengmk2@gmail.com>
 * MIT Licensed
 */

"use strict";

/**
 * Module dependencies.
 */

var debug = require('debug')('jscover');
var execFile = require('child_process').execFile;
var path = require('path');
var ndir = require('ndir');
var fse = require('fs-extra');
var fs = require('fs');

var root = path.dirname(__dirname);
var JSCoverPath = process.env.JSCOVER || path.join(root, 'bin', 'JSCover-all.jar');
var JSCoverLogging = path.join(root, 'bin', 'logging.properties');
var JSCoverCommand = ['java',
  '-Dfile.encoding=UTF-8',
  '-Djava.util.logging.config.file="' + JSCoverLogging + '"',
  '-jar "' + JSCoverPath + '"',
  '-fs'].join(' ');

/**
 * Pedding codes to support nodejs
 * @type {String}
 */
var PEDDING = "/* ****** automatically generated by jscover - do not edit ******/\n\
if (typeof _$jscoverage === 'undefined') { _$jscoverage = {}; }\n\
/* ****** end - do not edit ******/\n";

module.exports = function jscover(source, target, options, callback) {
  source = source || '';
  target = target || '';
  options = options || [];
  var tmpName = '__cov__' + Date.now();
  var tmpdir = process.env.TMPDIR || '/tmp';
  var tmpTargetDir = path.join(tmpdir, tmpName);
  var tmpTarget = path.join(tmpTargetDir, path.basename(target));

  var cleanup = function () {
    fse.removeSync(tmpTargetDir);
    fse.removeSync(path.join(target, tmpName));
  };

  var cmd = JSCoverCommand;
  if (options && options.length > 0) {
    cmd += ' ' + options.join(' ');
  }
  cmd += ' --exclude=node_modules --exclude=.git/ --exclude=.svn/';
  cmd += ' --exclude="' + tmpTarget + '" --exclude="' + target + '"';
  cmd += ' "' + source + '" "' + tmpTarget + '"';

  cmd = cmd.split(' ');
  debug(cmd);
  var child = execFile(cmd[0], cmd.slice(1), function (err, stdout, stderr) {
    var output = '';
    if (stdout) {
      output += stdout;
    }
    if (stderr) {
      output += stderr;
      if (!err) {
        err = new Error(stderr.trim());
      }
      err.name = 'JSCover' + err.name;
    }
    if (err) {
      debug(err, stderr);
      cleanup();
      return callback(err, output);
    }

    var success = !stdout && !stderr;
    if (!success) {
      return callback(null, output);
    }
    ndir.walk(tmpTarget, function onDir(dirpath, items) {
      var todir = dirpath.replace(tmpTarget, target);
      fse.mkdirpSync(todir);
      for (var i = 0; i < items.length; i++) {
        var info = items[i];
        var from = info[0];
        var name = path.basename(from);
        if (name === '.git' || name === '.svn' || name.indexOf('jscoverage') === 0) {
          continue;
        }
        var to = path.join(todir, path.basename(from));
        if (info[1].isDirectory()) {
          fse.mkdirpSync(to);
        } else if (info[1].isFile()) {
          var content = fs.readFileSync(from);
          if (path.extname(to).toLowerCase() === '.js') {
            content = PEDDING + content.toString();
          }
          fs.writeFileSync(to, content);
        }
      }
    }, function end() {
      cleanup();
      callback();
    }, function error(err, errPath) {
      cleanup();
      console.error('%s error: %s', errPath, err);
      callback(err);
    });

  });
};
